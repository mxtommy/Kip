<form (ngSubmit)="submitConfig()" [formGroup]="formMaster">
  <h6 mat-dialog-title>{{ titleDialog }}</h6>
  <mat-dialog-content class="widget-config-dialog-content">
    <mat-tab-group class="tab-group-content">
      <mat-tab label="Display">
        @if ((widgetConfig?.datasetUUID !== undefined)) {
        <config-display-chart-options
          class="tab-content"
          [displayName]="displayNameToControl"
          [datasetUUID]="datasetUUIDToControl"
          [convertUnitTo]="convertUnitToControl"
          [showAverageData]="showAverageDataToControl"
          [trackAgainstAverage]="trackAgainstAverageToControl"
          [datasetAverageArray]="datasetAverageArrayToControl"
          [showDatasetMinimumValueLine]="showDatasetMinimumValueLineToControl"
          [showDatasetMaximumValueLine]="showDatasetMaximumValueLineToControl"
          [showDatasetAverageValueLine]="showDatasetAverageValueLineToControl"
          [showDatasetAngleAverageValueLine]="showDatasetAngleAverageValueLineToControl"
          [startScaleAtZero]="startScaleAtZeroToControl"
          [showLabel]="showLabelToControl"
          [showTimeScale]="showTimeScaleToControl"
          [showYScale]="showYScaleToControl"
          [yScaleSuggestedMin]="yScaleSuggestedMinToControl"
          [yScaleSuggestedMax]="yScaleSuggestedMaxToControl"
          [enableMinMaxScaleLimit]="enableMinMaxScaleLimitToControl"
          [yScaleMin]="yScaleMinToControl"
          [yScaleMax]="yScaleMaxToControl"
          [numDecimal]="numDecimalToControl"
          [verticalChart]="verticalChartToControl"
          [inverseYAxis]="inverseYAxisToControl"
          [color]="colorToControl"
        />
        } @else if (widgetConfig?.autopilot) {
        <select-autopilot formGroupName="autopilot" class="tab-content" />
        } @else {
        <div class="display-content tab-content">
          <div class="widget-options-grid">
            @if ((widgetConfig?.widgetUrl !== undefined)) {
            <mat-form-field class="options-grid-span2">
              <mat-label>URL</mat-label>
              <input
                type="url"
                matInput
                placeholder="Enter URL to page/resource"
                name="widgetUrl"
                formControlName="widgetUrl"
              />
            </mat-form-field>
            } @if ((widgetConfig?.allowInput !== undefined)) {
            <mat-checkbox
              class="options-grid-span2"
              name="allowInput"
              formControlName="allowInput"
            >
              Allow pointer events on embedded content. WARNING: this may
              prevent swipe gestures over the Embed widget or keyboard events,
              while the focus is in the embed, from triggering normal KIP
              interactions.
            </mat-checkbox>
            } @if ((widgetConfig?.displayName !== undefined)) {
            <mat-form-field class="options-grid-span2">
              <mat-label>Widget Label</mat-label>
              <input
                matInput
                placeholder="Enter a label to display"
                name="displayName"
                formControlName="displayName"
              />
            </mat-form-field>
            } @if (formMaster.get('displayScale')) {
            <mat-form-field formGroupName="displayScale" appearance="outline">
              <mat-label>Scale Start</mat-label>
              <input
                matNativeControl
                type="number"
                name="lower"
                formControlName="lower"
                placeholder="Enter number..."
              />
            </mat-form-field>
            <mat-form-field formGroupName="displayScale" appearance="outline">
              <mat-label>Scale End</mat-label>
              <input
                matInput
                type="number"
                name="upper"
                formControlName="upper"
                placeholder="Enter number..."
              />
            </mat-form-field>
            } @if ((widgetConfig?.numInt !== undefined)) {
            <mat-form-field>
              <mat-label>Integer Places</mat-label>
              <input
                type="number"
                min="1"
                max="5"
                matInput
                placeholder="Enter or select number..."
                name="numInt"
                formControlName="numInt"
                required
              />
            </mat-form-field>
            } @if ((widgetConfig?.numDecimal !== undefined)) {
            <mat-form-field
              [class]="
                widgetConfig.showMiniChart !== undefined
                  ? 'options-grid-span2'
                  : ''
              "
            >
              <mat-label>Decimal Places</mat-label>
              <input
                type="number"
                min="0"
                max="5"
                matInput
                placeholder="Enter or select number..."
                name="numDecimal"
                formControlName="numDecimal"
                required
              />
            </mat-form-field>
            } @if ((widgetConfig?.showMin !== undefined)) {
            <mat-checkbox name="showMin" formControlName="showMin">
              Show Min recorded value
            </mat-checkbox>
            } @if ((widgetConfig?.showMax !== undefined)) {
            <mat-checkbox name="showMax" formControlName="showMax">
              Show Max recorded value
            </mat-checkbox>
            } @if ((widgetConfig?.nextDashboard !== undefined)) {
            <mat-form-field [class.options-grid-span2]="!widgetConfig.numInt">
              <mat-label>Next Dashboard after start</mat-label>
              <input
                type="number"
                min="0"
                max="99"
                matInput
                placeholder="Enter or select number..."
                name="nextDashboard"
                formControlName="nextDashboard"
              />
            </mat-form-field>
            } @if ((widgetConfig?.convertUnitTo !== undefined)) {
            <mat-form-field class="fields">
              <mat-label>Display Units</mat-label>
              <mat-select
                placeholder="Select unit"
                formControlName="convertUnitTo"
                required
              >
                @for (group of unitList.conversions; track $index) { @if
                (!widgetConfig.convertUnitToGroup ||
                widgetConfig.convertUnitToGroup === '' ||
                widgetConfig.convertUnitToGroup === group.group) {
                <mat-optgroup [label]="group.group">
                  @for (unit of group.units; track $index) {
                  <mat-option [value]="unit.measure">
                    {{
                      unit.measure === 'ratio' ? 'ratio #' : unit.measure
                    }}
                  </mat-option>
                  }
                </mat-optgroup>
                } }
              </mat-select>
            </mat-form-field>
            } @if ((widgetConfig?.unitGroup !== undefined)) {
            <mat-form-field class="fields">
              <mat-label>Measurements Group</mat-label>
              <mat-select
                placeholder="Select group"
                formControlName="unitGroup"
                required
              >
                @for (group of unitList.unitList; track $index) {
                <mat-option [value]="$index">{{ group.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            }
            @if ((widgetConfig?.convertMap !== undefined)) {
            <div formGroupName="convertMap">
              <div
                class="options-grid-span2 map-table"
                *ngIf="unitList.convertMap; else loadingConvertMap"
              >
                <table>
                  <tr>
                    <th>Measure</th>
                    <th>From Unit</th>
                    <th>Group</th>
                  </tr>
                  @for (conv of unitList.convertMap | keyvalue; track $index) {
                  <tr>
                    <td>{{ conv.key }}</td>
                    <td>{{ conv.value.unit }}</td>
                    <td>{{ conv.value.group }}</td>
                  </tr>
                  }
                </table>
              </div>
              <ng-template #loadingConvertMap>
                <div class="options-grid-span2">Loading convert map...</div>
              </ng-template>
            </div>
            }
            @if ((widgetConfig?.showMiniChart !== undefined)) {
            <mat-checkbox name="showMiniChart" formControlName="showMiniChart">
              Show Mini Chart
            </mat-checkbox>
            }
            @if ((widgetConfig?.showAverage !== undefined)) {
            <mat-checkbox name="showAverage" formControlName="showAverage">
              Show Average (must have Avg path configured in Dataset)
            </mat-checkbox>
            }
            @if ((widgetConfig?.centerLabel !== undefined)) {
            <mat-checkbox name="centerLabel" formControlName="centerLabel">
              Show label within gauge
            </mat-checkbox>
            }
            @if ((widgetConfig?.showTimeSeries !== undefined)) {
            <mat-checkbox
              name="showTimeSeries"
              formControlName="showTimeSeries"
            >
              Show Time Series Selection
            </mat-checkbox>
            }
            @if ((widgetConfig?.digitalPanel !== undefined)) {
            <mat-checkbox name="digitalPanel" formControlName="digitalPanel">
              Show numeric value
            </mat-checkbox>
            }
            @if ((widgetConfig?.showLimits !== undefined)) {
            <mat-checkbox name="showLimits" formControlName="showLimits">
              Show Min/Max Values
            </mat-checkbox>
            }
            @if ((widgetConfig?.showDeveloperInfo !== undefined)) {
            <mat-checkbox
              name="showDeveloperInfo"
              formControlName="showDeveloperInfo"
            >
              Show Dataset Developer Info
            </mat-checkbox>
            }
            @if ((widgetConfig?.applyAbsolute !== undefined)) {
            <mat-checkbox name="applyAbsolute" formControlName="applyAbsolute">
              Use absolute value
            </mat-checkbox>
            }
            @if ((widgetConfig?.inverseYAxis !== undefined)) {
            <mat-checkbox name="inverseYAxis" formControlName="inverseYAxis">
              Inverse Y axis direction
            </mat-checkbox>
            }
            @if ((widgetConfig?.startScaleAtZero !== undefined)) {
            <mat-checkbox
              name="startScaleAtZero"
              formControlName="startScaleAtZero"
            >
              Force zero based scale
            </mat-checkbox>
            }
            @if ((widgetConfig?.verticalChart !== undefined)) {
            <mat-checkbox
              name="verticalChart"
              formControlName="verticalChart"
            >
              Vertical chart
            </mat-checkbox>
            }
            @if ((widgetConfig?.showMinMaxDuration !== undefined)) {
            <mat-form-field>
              <mat-label>Min/Max Duration (minutes)</mat-label>
              <input
                type="number"
                min="1"
                max="60"
                matInput
                placeholder="Enter or select number..."
                name="showMinMaxDuration"
                formControlName="showMinMaxDuration"
                required
              />
            </mat-form-field>
            }
            @if ((widgetConfig?.label !== undefined)) {
            <mat-form-field>
              <mat-label>Widget Label</mat-label>
              <input
                matInput
                placeholder="Enter a label to display"
                name="label"
                formControlName="label"
              />
            </mat-form-field>
            }
            @if ((widgetConfig?.labelPos !== undefined)) {
            <mat-form-field>
              <mat-label>Label Position</mat-label>
              <mat-select
                matInput
                placeholder="Select position..."
                name="labelPos"
                formControlName="labelPos"
              >
                <mat-option value="bottom">Bottom</mat-option>
                <mat-option value="center">Center</mat-option>
                <mat-option value="top">Top</mat-option>
              </mat-select>
            </mat-form-field>
            }
            @if ((widgetConfig?.bgColor !== undefined)) {
            <mat-form-field>
              <mat-label>Background Color</mat-label>
              <mat-select
                placeholder="Select Color..."
                formControlName="bgColor"
                name="bgColor"
                required
              >
                @for(color of colors; track $index) {
                <mat-option value="{{ color.value }}">{{
                  color.label
                }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            }
            <!-- Gauge specific options -->
            @if (widgetConfig.gauge?.type == 'horizon') {
              <mat-form-field formGroupName="gauge">
                <mat-label>Pointer Colour</mat-label>
                <mat-select
                  placeholder="Select colour..."
                  formControlName="faceColor"
                  name="faceColor">
                  <mat-option value='Red'>Red</mat-option>
                  <mat-option value='Green'>Green</mat-option>
                  <mat-option value='Blue'>Blue</mat-option>
                  <mat-option value='White'>White</mat-option>
                  <mat-option value='Black'>Black</mat-option>
                  <mat-option value='Orange'>Orange</mat-option>
                  <mat-option value='Yellow'>Yellow</mat-option>
                  <mat-option value='Gray'>Gray</mat-option>
                  <mat-option value='Magenta'>Magenta</mat-option>
                  <mat-option value='Green LCD'>Green LCD</mat-option>
                </mat-select>
              </mat-form-field>
            }
            @if (widgetConfig?.gauge?.type === 'steel') {
            <mat-form-field formGroupName="gauge">
              <mat-label>Background Style</mat-label>
              <mat-select
                placeholder="Select style..."
                formControlName="backgroundColor"
                name="backgroundColor"
              >
                <mat-option value="darkGray">Dark Gray</mat-option>
                <mat-option value="satinGray">Satin Gray</mat-option>
                <mat-option value="lightGray">Light Gray</mat-option>
                <mat-option value="white">White</mat-option>
                <mat-option value="black">Black</mat-option>
                <mat-option value="beige">Beige</mat-option>
                <mat-option value="brown">Brown</mat-option>
                <mat-option value="red">Red</mat-option>
                <mat-option value="green">Green</mat-option>
                <mat-option value="blue">Blue</mat-option>
                <mat-option value="anthracite">Anthracite</mat-option>
                <mat-option value="mud">Mud</mat-option>
                <mat-option value="punchedSheet">Punched Sheet</mat-option>
                <mat-option value="carbon">Carbon</mat-option>
                <mat-option value="stainless">Stainless</mat-option>
                <mat-option value="brushedMetal">Brushed Metal</mat-option>
                <mat-option value="brushedStainless">Brushed Stainless</mat-option>
                <mat-option value="turned">Turned</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field formGroupName="gauge">
              <mat-label>Frame Style</mat-label>
              <mat-select
                placeholder="Select style..."
                formControlName="faceColor"
                name="faceColor"
              >
                <mat-option value="blackMetal">Black Metal</mat-option>
                <mat-option value="metal">Metal</mat-option>
                <mat-option value="shinyMetal">Shiny Metal</mat-option>
                <mat-option value="brass">Brass</mat-option>
                <mat-option value="steel">Steel</mat-option>
                <mat-option value="chrome">Chrome</mat-option>
                <mat-option value="gold">Gold</mat-option>
                <mat-option value="anthracite">Anthracite</mat-option>
                <mat-option value="tiltedGray">Tilted Gray</mat-option>
                <mat-option value="tiltedBlack">Tilted Black</mat-option>
                <mat-option value="glossyMetal">Glossy Metal</mat-option>
              </mat-select>
            </mat-form-field>
            }
          </div>
          <!-- end Gauge stuff-->
        </div>
        }
      </mat-tab>
      <!-- Boolean Multi Child Control Config Panel -->
      @if ((widgetConfig?.multiChildCtrls !== undefined)) {
      <mat-tab label="Controls">
        <div class="tab-content">
          <div>
            <ng-template mat-tab-label>
              <span
                [style]="
                  formMaster.controls.multiChildCtrls.valid
                    ? 'display: none'
                    : 'display: block'
                "
                class="warning fa fa-exclamation-circle"
              ></span
              >&nbsp;Controls
            </ng-template>
          </div>
          <boolean-multicontrol-options
            [multiCtrlArray]="multiChildCtrlsToControl"
            (addPath)="addPathGroup($event)"
            (updatePath)="updatePath($event)"
            (delPath)="deletePath($event)"
          >
          </boolean-multicontrol-options>
        </div>
      </mat-tab>
      }
      <!-- Paths stuff -->
      @if ((widgetConfig?.paths !== undefined)) {
      <mat-tab label="Paths">
        <div class="tab-content">
          <div>
            <ng-template mat-tab-label>
              <span
                [style]="
                  formMaster.controls.paths.valid ||
                  formMaster.controls.paths.disabled
                    ? 'display: none'
                    : 'display: block'
                "
                class="warning material-icons"
              >
                error
              </span>
              &nbsp;Paths
            </ng-template>
          </div>
          <paths-options
            formGroupName="paths"
            [isArray]="isPathArray"
            [enableTimeout]="enableTimeoutToControl"
            [dataTimeout]="dataTimeoutToControl"
            [filterSelfPaths]="filterSelfPathsToControl"
            [addPathEvent]="addPathEvent"
            [delPathEvent]="delPathEvent"
            [updatePathEvent]="updatePathEvent"
          >
          </paths-options>
        </div>
      </mat-tab>
      }
      <!-- Gauge stuff -->
      @if (widgetConfig?.gauge?.type === "steel") {
      <mat-tab label="Settings" formGroupName="gauge">
        <div class="display-content tab-content">
          <mat-form-field class="options-grid-span2">
            <mat-label>Gauge Type</mat-label>
            <mat-select
              placeholder="Select type..."
              formControlName="subType"
              name="subType"
            >
              <mat-option value="linear">Linear</mat-option>
              <mat-option value="radial">Radial</mat-option>
            </mat-select>
          </mat-form-field>
          @if (formMaster.value.gauge.subType === 'linear') {
          <p>
            <mat-checkbox formControlName="digitalMeter" name="digitalMeter">
              Digital display
            </mat-checkbox>
          </p>
          } @if (formMaster.value.gauge.subType === 'radial') {
          <mat-form-field class="options-grid-span2">
            <mat-label>Dial Size</mat-label>
            <mat-select
              placeholder="Select size..."
              formControlName="radialSize"
              name="radialSize"
            >
              <mat-option value="quarter">1/4</mat-option>
              <mat-option value="half">1/2</mat-option>
              <mat-option value="three-quarter">3/4</mat-option>
              <mat-option value="full">Full</mat-option>
            </mat-select>
          </mat-form-field>
          }
        </div>
      </mat-tab>
      }
      <!-- end Gauge stuff-->

      <!-- PUT Requests -->
      @if ((widgetConfig?.putEnable !== undefined) &&
      (widgetConfig?.multiChildCtrls === undefined)) {
      <mat-tab label="Put Request">
        <div class="tab-content">
          <p>
            <mat-checkbox formControlName="putEnable" name="putEnable">
              Enable Put Requests
            </mat-checkbox>
          </p>
          <p>
            <mat-checkbox formControlName="putMomentary" name="putMomentary">
              Momentary mode (instead of switching between on/off)
            </mat-checkbox>
          </p>
          @if (formMaster.controls.putMomentary.value) {
          <p>
            <mat-checkbox
              formControlName="putMomentaryValue"
              name="putMomentaryValue"
            >
              Value to send on button push (checked = on, unchecked = off)
            </mat-checkbox>
          </p>
          }
        </div>
      </mat-tab>
      }
      <!-- End PUT Requests-->

      <!-- Charts -->
      @if ((widgetConfig?.datasetUUID !== undefined)) {
      <mat-tab label="Dataset">
        <ng-template mat-tab-label>
          @if (!formMaster.controls.datasetUUID.valid) {
          <span class="warning fa fa-exclamation-circle"></span>
          } Dataset
        </ng-template>
        <config-dataset-chart-options
          [datasetUUID]="datasetUUIDToControl"
          [convertUnitTo]="convertUnitToControl"
        >
        </config-dataset-chart-options>
      </mat-tab>
      }
      <!-- end Chart -->
    </mat-tab-group>
  </mat-dialog-content>
  <mat-divider></mat-divider>
  <mat-dialog-actions>
    <button type="button" mat-dialog-close mat-flat-button>Cancel</button>
    <button mat-flat-button type="submit" [disabled]="!formMaster.valid">
      Save
    </button>
  </mat-dialog-actions>
</form>
